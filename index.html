<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>Title</title>
    <link href="dist/output.css" rel="stylesheet" />
  </head>
  <body>
    <header>
      <nav class="navbar navbar-expand-lg shadow-md py-2 bg-white relative flex items-center w-full justify-between">
        <div class="px-6 w-full flex flex-wrap items-center justify-between">
          <div class="navbar-collapse collapse grow items-center" id="navbarSupportedContentY">
            <ul class="navbar-nav mr-auto lg:flex lg:flex-row">
              <li class="nav-item">
                <a
                  class="nav-link block pr-2 lg:px-2 py-2 font-bold text-gray-600 hover:text-gray-700 focus:text-gray-700 transition duration-150 ease-in-out"
                  data-mdb-ripple="true"
                  data-mdb-ripple-color="light"
                  href="/"
                  >Zoom振り分けくん</a
                >
              </li>
            </ul>
          </div>
        </div>
      </nav>
    </header>

    <div class="container">
      <div class="mt-3">
        <form action="" class="form-group" id="form-group" method="post">
          <div class="form-group-num">
            <label for="group-num">ブレイクアウトルームの数</label>
            <input
              class="group-num focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md"
              id="group-num"
              required
              type="text"
            />
          </div>
          <div class="form-submit mt-2">
            <input
              class="py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
              type="submit"
              value="振り分け！"
            />
          </div>
        </form>
      </div>
      <div class="fixed hidden inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full" id="my-modal">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
          <div class="mt-3 text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100">
              <svg class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M5 13l4 4L19 7" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
              </svg>
            </div>
            <!--          <h3 class="text-lg leading-6 font-medium text-gray-900">成功しました！</h3>-->
            <div class="mt-2 px-7 py-3">
              <p class="text-sm text-gray-500" id="result"></p>
            </div>
            <div class="items-center px-4 py-3">
              <button
                class="px-4 py-2 bg-green-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-300"
                id="ok-btn"
              >
                OK
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script src="src/js/display-modal.js"></script>
    <script src="src/js/display-lottery-result.js"></script>
    <script src="src/js/distribute.js"></script>
    <script>
      let groupId = 0;
      let nameId = 0;
      let areaId = 0;

      function addGroupForm() {
        const contentArea = document.getElementById('form-group');
        const newFromAttributeGroup = document.createElement('div');
        groupId++;
        nameId++;
        areaId++;
        newFromAttributeGroup.setAttribute('id', `form-group-${groupId}`);
        newFromAttributeGroup.className = 'mt-3 p-3 bg-gray-50 rounded-md shadow sm:rounded-md sm:overflow-hidden';
        newFromAttributeGroup.innerHTML = `
      <div class='col-span-6 sm:col-span-4'>
        <label for='element'>属性</label>
        <input
          type='text'
          class='element focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md'
          id='element'
          required
        />
      </div>
      <div id='form-area-${areaId}' class='grid grid-cols-3 gap-6'>
        <div id='form-input-info-${nameId}' class='form-group'>
          <div class='mt-2'>
            <div>
              <label for='element'>名前</label>
              <input
                type='text'
                class='name group-num focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md'
                id='name'
                required
              />
            </div>
            <div class='mt-1'>
              <label for='element'>Zoomのメールアドレス</label>
              <input
                type='text'
                class='email focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md'
                id='email'
                required
              />
            </div>
          </div>
          <div class='mt-3'>
            <input
              type='button'
              class='bg-white py-2 px-3 border border-gray-300 rounded-md shadow-sm text-sm leading-4 font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500'
              value='＋'
              onclick="addInputInfo('form-area-${areaId}')"
            />
            <input
              type='button'
              class='bg-white py-2 px-3 border border-gray-300 rounded-md shadow-sm text-sm leading-4 font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500'
              value='－'
              onclick="deleteElement('form-input-info-${nameId}')"
            />
          </div>
        </div>
      </div>
      <div class='mt-3'>
        <input
          type='button'
          class='bg-white py-2 px-3 border border-gray-300 rounded-md shadow-sm text-sm leading-4 font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500'
          value='属性を追加'
          onclick='addGroupForm()'
        />
        <input
          type='button'
          class='bg-red-600 py-2 px-3 border border-transparent rounded-md shadow-sm text-sm leading-4 font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500'
          value='属性を削除'
          onclick="deleteElement('form-group-${groupId}')"
        />
      </div>
    `;
        contentArea.appendChild(newFromAttributeGroup);
      }

      function deleteElement(idName) {
        const contentArea = document.getElementById(idName);
        contentArea.remove();
      }

      function addInputInfo(addAreaId) {
        const contentArea = document.getElementById(addAreaId);
        const newFromAttributeGroup = document.createElement('div');
        nameId++;
        newFromAttributeGroup.setAttribute('id', `form-input-info-${nameId}`);
        newFromAttributeGroup.innerHTML = `
          <div class='mt-2'>
            <div>
              <label for='element'>名前</label>
              <input
                type='text'
                class='name group-num focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md'
                id='name'
                required
              />
            </div>
            <div class='mt-1'>
              <label for='element'>Zoomのメールアドレス</label>
              <input
                type='text'
                class='email focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md'
                id='email'
                required
              />
            </div>
          </div>
          <div class='mt-3'>
            <input
              type='button'
              class='bg-white py-2 px-3 border border-gray-300 rounded-md shadow-sm text-sm leading-4 font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500'
              value='＋'
              onclick="addInputInfo('form-area-${areaId}')"
            />
            <input
              type='button'
              class='bg-white py-2 px-3 border border-gray-300 rounded-md shadow-sm text-sm leading-4 font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500'
              value='－'
              onclick="deleteElement('form-input-info-${nameId}')"
            />
          </div>
    `;
        contentArea.appendChild(newFromAttributeGroup);
      }

      window.addEventListener('DOMContentLoaded', function () {
        addGroupForm();

        // HTML要素を取得
        let formGroup = document.getElementById('form-group');

        // submitを待っている
        formGroup.addEventListener('submit', function (e) {
          // 今出ている'form-area-i'を判別し、属性を配列に入れる。
          let elementList = [];
          let elementCount = 0;

          for (let i = 1; i <= groupId; i++) {
            if (document.getElementById('form-group-' + i) != null) {
              // 'form-area-i'のdiv要素の個数を取得
              const elementListCount = document.querySelectorAll('#form-area-' + i + ' div').length;

              // 要素分属性の配列に追加
              for (let j = 0; j < elementListCount; j++) {
                elementList.push(elementCount);
              }
              elementCount++;
            }
          }

          console.log('要素の配列');
          console.log(elementList);

          // 人の名前の表示
          const nameListClass = document.getElementsByClassName('name');
          let nameList = [];
          for (let i = 0; i < nameListClass.length; i++) {
            nameList.push(nameListClass[i].value);
          }
          console.log('名前の配列');
          console.log(nameList);

          // メアドの表示
          const emailListClass = document.getElementsByClassName('email');
          let emailList = [];
          for (let i = 0; i < emailListClass.length; i++) {
            emailList.push(emailListClass[i].value);
          }
          console.log('メールの配列');
          console.log(emailList);

          // デバッグ時ページが更新されないようにイベントを止める
          e.preventDefault();
          const groupNum = document.getElementsByClassName('group-num');
          displayLotteryResult(distributeGroupMember(nameList, emailList, elementList, groupNum[0].value));
        });
      });
    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>Title</title>
  </head>
  <body>
    <div class="center-block">
      <h1>振り分けくん</h1>
    </div>

    <form action="" method="post" class="form-group" id="form-group">
      <div class="form-group-num">
        <label for="group-num">グループの数: </label>
        <input type="text" class="group-num" id="group-num" required />
      </div>
      <div class="form-submit">
        <input type="submit" value="振り分け！" />
      </div>
    </form>
    <div>
      <div id="result"></div>
    </div>
    <script src="src/js/display-lottery-result.js"></script>
    <script src="src/js/distribute.js"></script>
    <script>
      let groupId = 0;
      let nameId = 0;
      let areaId = 0;

      function addGroupForm() {
        const contentArea = document.getElementById('form-group');
        const newFromAttributeGroup = document.createElement('div');
        groupId++;
        nameId++;
        areaId++;
        newFromAttributeGroup.setAttribute('id', `form-group-${groupId}`);
        newFromAttributeGroup.innerHTML = `
      <div>
        <label for='element'>属性: </label>
        <input type='text' class='element' id='element' required />
      </div>
      <br />
      <div id='form-area-${areaId}' >
        <div id='form-input-info-${nameId}' class='form-group'>
          <label for='element'>名前: </label>
          <input type='text' class='name' id='name' required />
          <label for='element'>　　メアド: </label>
          <input type='text' class='email' id='email' required />
          <input type='button' value='＋' onclick="addInputInfo('form-area-${areaId}')" />
          <input type='button' value='－' onclick="deleteElement('form-input-info-${nameId}')" />
        </div>
      </div>
      <input type='button' value='＋' onclick='addGroupForm()' />
      <input type='button' value='－' onclick="deleteElement('form-group-${groupId}')" />
    `;
        contentArea.appendChild(newFromAttributeGroup);
      }

      function deleteElement(idName) {
        const contentArea = document.getElementById(idName);
        contentArea.remove();
      }

      function addInputInfo(addAreaId) {
        const contentArea = document.getElementById(addAreaId);
        const newFromAttributeGroup = document.createElement('div');
        nameId++;
        newFromAttributeGroup.setAttribute('id', `form-input-info-${nameId}`);
        newFromAttributeGroup.innerHTML = `
          <label for='element'>名前: </label>
          <input type='text' class='name' id='name' required />
          <label for='element'>　　メアド: </label>
          <input type='text' class='email' id='email' required />
          <input type='button' value='＋' onclick="addInputInfo('form-area-${areaId}')" />
          <input type='button' value='－' onclick="deleteElement('form-input-info-${nameId}')" />
    `;
        contentArea.appendChild(newFromAttributeGroup);
      }

      window.addEventListener('DOMContentLoaded', function () {
        addGroupForm();

        // HTML要素を取得
        let formGroup = document.getElementById('form-group');

        // submitを待っている
        formGroup.addEventListener('submit', function (e) {
          // 今出ている'form-area-i'を判別し、属性を配列に入れる。
          let elementList = [];
          let elementCount = 0;

          for (let i = 1; i <= groupId; i++) {
            if (document.getElementById('form-group-' + i) != null) {
              // 'form-area-i'のdiv要素の個数を取得
              const elementListCount = document.querySelectorAll('#form-area-' + i + ' div').length;

              // 要素分属性の配列に追加
              for (let j = 0; j < elementListCount; j++) {
                elementList.push(elementCount);
              }
              elementCount++;
            }
          }

          console.log('要素の配列');
          console.log(elementList);

          // 人の名前の表示
          const nameListClass = document.getElementsByClassName('name');
          let nameList = [];
          for (let i = 0; i < nameListClass.length; i++) {
            nameList.push(nameListClass[i].value);
          }
          console.log('名前の配列');
          console.log(nameList);

          // メアドの表示
          const emailListClass = document.getElementsByClassName('email');
          let emailList = [];
          for (let i = 0; i < emailListClass.length; i++) {
            emailList.push(emailListClass[i].value);
          }
          console.log('メールの配列');
          console.log(emailList);

          // デバッグ時ページが更新されないようにイベントを止める
          e.preventDefault();
          const groupNum = document.getElementsByClassName('group-num');
          displayLotteryResult(distributeGroupMember(nameList, emailList, elementList, groupNum[0].value));
        });
      });
    </script>
  </body>
</html>
